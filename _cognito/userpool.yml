Resources:
  UserPool:
    Type: "AWS::Cognito::UserPool"
    Properties:
      UserPoolName: Scorekeep
      Schema:
        - AttributeDataType: String
          Name: userid
      Policies:
        PasswordPolicy:
          MinimumLength: 6
      LambdaConfig:
        PreSignUp: { "Fn::GetAtt" : [ "UserConfirmFunction", "Arn" ] }
  UserPoolClient:
    Type: "AWS::Cognito::UserPoolClient"
    Properties:
        ClientName: Scorekeep
        ReadAttributes:
          - "custom:userid"
        UserPoolId: { "Ref" : "UserPool" }
        WriteAttributes:
          - "custom:userid"

  UserConfirmRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument: {
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "lambda.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Path: /service-role/

  UserConfirmFunction:
    Type: "AWS::Lambda::Function"
    Properties:
      Code:
        ZipFile: >
          exports.handler = function(event, context) {
              if(event.userPoolId === process.env.USERPOOL_ID) {
                  event.response.autoConfirmUser = true;
              }
              // Return result to Cognito
              context.done(null, event);
          };
      Description: "Confirm new cognito users"
      Environment:
        Variables:
          USERPOOL_ID: "PLACEHOLDER"
      FunctionName: scorekeep-confirm-user
      Handler: index.handler
      Role: { "Fn::GetAtt": ["UserConfirmRole", "Arn"] }
      Runtime: nodejs4.3

  UserConfirmFunctionPermission:
    Type: "AWS::Lambda::Permission"
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: { "Ref" : "UserConfirmFunction" }
      Principal: "cognito-idp.amazonaws.com"

Outputs:
  UserPoolId:
    Description: User pool ID
    Value: { "Ref" : "UserPool" }
    Export:
      Name: ScorekeepUserPoolId
  UserPoolClientId:
    Description: User pool client ID
    Value: { "Ref" : "UserPoolClient" }
