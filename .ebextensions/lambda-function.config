Resources:
  RandomNameFunction:
    Type: "AWS::Lambda::Function"
    Properties:
      Code:
        ZipFile: "PLACEHOLDER"
      Description: "Generate random names"
      Environment:
        Variables:
          REGION_NAME: {"Ref" : "AWS::Region"}
          TOPIC_ARN: {"Ref" : "NotificationTopic"}
      FunctionName: random-name-embedded
      Handler: index.handler
      Role: { "Fn::Join": [ "", [ "arn:aws:iam::",{"Ref" : "AWS::AccountId"},":role/service-role/scorekeep-lambda" ] ] }
      Runtime: nodejs4.3
      Timeout: 7

commands:
  install-npm:
    command: sudo -u ec2-user /tmp/install-npm.sh
    cwd: /home/ec2-user
    test: "[ ! -d /home/ec2-user/.nvm ]"

container_commands:
  update-random-name:
    command: /tmp/update-lambda.sh
    leader_only: true

files:
  "/tmp/install-npm.sh":
    mode: "000755"
    owner: ec2-user
    group: ec2-user
    content: |
      #!/bin/bash
      curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.1/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      nvm install 4.3.2
      mkdir -p /home/ec2-user/bin
      ln -fs /home/ec2-user/.nvm/versions/node/v4.3.2/bin/npm /home/ec2-user/bin/npm
      ln -fs /home/ec2-user/.nvm/versions/node/v4.3.2/bin/node /home/ec2-user/bin/node

  "/tmp/update-lambda.sh":
    mode: "000755"
    owner: ec2-user
    group: ec2-user
    content: |
      #!/bin/bash
      REGION=$(/opt/elasticbeanstalk/bin/get-config environment -k AWS_REGION)
      STAGINGDIR=$(/opt/elasticbeanstalk/bin/get-config container -k container_staging_dir)
      cd _lambda/random-name
      /home/ec2-user/bin/npm install
      zip -r ../random-name.zip *
      aws lambda update-function-code --function-name random-name-embedded --zip-file fileb://../random-name.zip --region $REGION
